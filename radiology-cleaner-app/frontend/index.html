<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radiology Code Semantic Cleaner</title>
    <!-- Fonts -->
    <link href="../fonts/Poppins/Poppins-Regular.ttf" rel="stylesheet" type="text/css">
    <link href="../fonts/PublicSans/PublicSans-Regular.ttf" rel="stylesheet" type="text/css">
    <!-- Unified Design System -->
    <link href="unified-styles.css" rel="stylesheet" type="text/css">
    <style>
        /* App-specific overrides for legacy compatibility */
        #fileInput { display: none; }
        
        /* Specific color overrides for the radiology app branding */
        .stat-value { 
            color: var(--color-primary); 
        }
        
        /* Feedback component styles - kept for functionality */
        .component-editor { 
            display: flex; 
            flex-direction: column; 
            gap: var(--space-2); 
        }
        .component-editor label { 
            font-size: var(--font-size-sm); 
            font-weight: var(--font-weight-bold); 
        }
        .component-editor input, .component-editor select { 
            padding: var(--space-1); 
            font-size: var(--font-size-sm); 
        }
        .component-tags { 
            display: flex; 
            flex-wrap: wrap; 
            gap: var(--space-1); 
            margin-top: var(--space-2); 
        }
        .editable-tag { 
            background: var(--color-info-light); 
            color: var(--color-info); 
            padding: var(--space-1) var(--space-2); 
            border-radius: var(--radius-sm); 
            font-size: var(--font-size-xs); 
            cursor: pointer; 
            border: 1px solid var(--color-info); 
        }
        .editable-tag:hover { 
            background: #bbdefb; 
        }
        .add-anatomy-btn { 
            background: var(--color-success); 
            color: var(--color-white); 
            border: none; 
            padding: var(--space-1) var(--space-2); 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            font-size: var(--font-size-xs); 
        }
        .add-anatomy-btn:hover { 
            background: var(--color-success-hover); 
        }
        
        /* Correction modal specific styles */
        .correction-modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: var(--z-modal); 
        }
        .correction-modal-content { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: var(--color-white); 
            padding: var(--space-8); 
            border-radius: var(--radius-base); 
            max-width: 800px; 
            width: 90%; 
            max-height: 80vh; 
            overflow-y: auto; 
        }
        .correction-form { 
            display: flex; 
            flex-direction: column; 
            gap: var(--space-4); 
        }
        .correction-comparison { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: var(--space-4); 
            margin: var(--space-4) 0; 
        }
        .correction-original, .correction-corrected { 
            padding: var(--space-4); 
            border-radius: var(--radius-base); 
        }
        .correction-original { 
            background: var(--color-warning-light); 
            border: 1px solid var(--color-warning); 
        }
        .correction-corrected { 
            background: var(--color-info-light); 
            border: 1px solid var(--color-info); 
        }
        .correction-buttons { 
            display: flex; 
            gap: var(--space-4); 
            justify-content: flex-end; 
            margin-top: var(--space-4); 
        }
        .feedback-button { 
            background: var(--color-info); 
            color: var(--color-white); 
            border: none; 
            padding: var(--space-1) var(--space-2); 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            font-size: var(--font-size-xs); 
            transition: var(--transition-base); 
        }
        .feedback-button:hover { 
            background: var(--color-info); 
            opacity: 0.8; 
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Enhanced Header with Modern Design -->
        <div class="app-header">
            <div class="brand-bar">
                <div class="brand-content">
                    <img src="../images/HealthNZ_logo_v2.svg" alt="Health New Zealand Logo" class="app-logo" onerror="this.style.display='none'">
                    <div class="header-divider"></div>
                    <div class="brand-text">
                        <h1 class="brand-title">Radiology Code Semantic Cleaner</h1>
                        <p class="brand-subtitle">AI-powered standardization for radiology exam names</p>
                    </div>
                </div>
                
                <!-- Hamburger Menu -->
                <div class="hamburger-menu">
                    <button id="hamburgerToggle" class="hamburger-button">
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                    </button>
                    
                    <div id="hamburgerDropdown" class="hamburger-dropdown hidden">
                        <div class="dropdown-section">
                            <button id="menuHelp" class="dropdown-item">
                                <span class="dropdown-icon nerd-icon">Û∞ãñ</span>
                                System Documentation
                            </button>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-section">
                            <button id="menuAbout" class="dropdown-item">
                                <span class="dropdown-icon nerd-icon">‚Ñπ</span>
                                About
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-card">
            <div id="uploadSection" class="upload-section">
                <div class="upload-icon">üì§</div>
                <h2>Upload Radiology Codes JSON</h2>
                <p>Drop your codes.json file here or click to browse. You can also <a href="./example-codes.json" download>download a sample file</a>.</p>
                <input type="file" id="fileInput" accept=".json" />
            </div>

            <div class="file-info" id="fileInfo"></div>
            <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>

            <div class="results-section" id="resultsSection">
                <h2>üìä Cleaning Results</h2>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="originalCount">0</div><div class="stat-label">Original Codes</div></div>
                    <div class="stat-card"><div class="stat-value" id="cleanCount">0</div><div class="stat-label">Clean Names</div></div>
                    <div class="stat-card"><div class="stat-value" id="consolidationRatio">0</div><div class="stat-label">Consolidation Ratio</div></div>
                    <div class="stat-card"><div class="stat-value" id="modalityCount">0</div><div class="stat-label">Modalities</div></div>
                    <div class="stat-card"><div class="stat-value" id="avgConfidence">0</div><div class="stat-label">Avg Confidence</div></div>
                    <div class="stat-card"><div class="stat-value" id="genderContext">0</div><div class="stat-label">Gender Context</div></div>
                </div>
                <div class="action-buttons">
                    <button class="button success" id="exportMappingsBtn">üíæ Export Clean Mappings</button>
                    <button class="button secondary" id="exportSummaryBtn">üìã Export Summary Report</button>
                    <button class="button secondary" id="viewConsolidationsBtn">üîç View Top Consolidations</button>
                </div>
                
                <!-- View Toggle -->
                <div class="view-toggle" style="margin: 2rem 0; text-align: center;">
                    <button class="button active" id="sampleViewBtn">üìã Sample View</button>
                    <button class="button secondary" id="consolidatedViewBtn">üìä Consolidated View</button>
                </div>
                
                <!-- Sample View -->
                <div id="sampleView">
                    <h3>Sample Mappings</h3>
                    <div class="table-container">
                        <table class="results-table" id="resultsTable">
                            <thead><tr><th>Source</th><th>Original Code</th><th>Original Name</th><th>Clean Name</th><th>SNOMED Code</th><th>SNOMED FSN</th><th>Components</th><th>Context</th><th>Confidence</th></tr></thead>
                            <tbody id="resultsBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Consolidated View -->
                <div id="consolidatedView" style="display: none;">
                    <h3>Consolidated Results</h3>
                    <div class="consolidated-controls" style="margin-bottom: 1rem;">
                        <input type="text" id="consolidatedSearch" placeholder="Search consolidated names..." style="padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; width: 300px;">
                        <select id="consolidatedSort" style="padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; margin-left: 1rem;">
                            <option value="count">Sort by Count</option>
                            <option value="name">Sort by Name</option>
                            <option value="confidence">Sort by Confidence</option>
                        </select>
                    </div>
                    <div id="consolidatedResults"></div>
                </div>
            </div>
        </div>

        <!-- Feedback System (Hidden) -->
        <div class="main-card feedback-section" style="display: none;">
            <h2>üí¨ Feedback System</h2>
            <div class="feedback-tabs">
                <div class="feedback-tab active" data-tab="general">General Suggestions</div>
                <div class="feedback-tab" data-tab="corrections">Code Corrections</div>
            </div>
            
            <!-- General Suggestions Panel -->
            <div id="generalFeedbackPanel" class="feedback-panel active">
                <form class="feedback-form" id="generalFeedbackForm">
                    <div class="form-row">
                        <div>
                            <label for="generalUserName">Your Name:</label>
                            <input type="text" id="generalUserName" placeholder="Dr. Smith" required>
                        </div>
                        <div>
                            <label for="generalConfidence">Confidence Level:</label>
                            <select id="generalConfidence" required>
                                <option value="">Select confidence...</option>
                                <option value="low">Low - Suggestion for consideration</option>
                                <option value="medium">Medium - Likely improvement</option>
                                <option value="high">High - Definite improvement needed</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="generalSuggestion">Suggestion:</label>
                        <textarea id="generalSuggestion" placeholder="Example: 'KUB stands for Kidneys Ureter and Bladder but is typically its own specific type of Abdominal study'" required></textarea>
                    </div>
                    
                    <div>
                        <label for="generalNotes">Additional Notes (Optional):</label>
                        <textarea id="generalNotes" placeholder="Any additional context or examples..."></textarea>
                    </div>
                    
                    <button type="submit" class="button">Submit Suggestion</button>
                </form>
                <div id="generalFeedbackResult"></div>
            </div>
            
            <!-- Corrections Panel -->
            <div id="correctionsFeedbackPanel" class="feedback-panel">
                <p>Use the "Provide Feedback" buttons in the consolidated view above to submit corrections for specific radiology codes.</p>
                <div id="correctionsFeedbackResult"></div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal-overlay hidden">
        <div class="modal-container help-modal">
            <div class="modal-header">
                <h2>System Documentation</h2>
                <button id="closeHelpModal" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="help-content">
                    <div id="helpContent" class="help-text">
                        <!-- Help content will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeHelpBtn" class="button primary">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="consolidationModal">
        <div class="modal-content">
            <span class="close-modal" id="closeModalBtn">√ó</span>
            <h2>Top Consolidation Examples</h2>
            <div id="consolidationExamples" class="consolidation-examples"></div>
        </div>
    </div>

    <!-- Correction Modal -->
    <div id="correctionModal" class="correction-modal">
        <div class="correction-modal-content">
            <span id="closeCorrectionModalBtn" class="close-modal">&times;</span>
            <h2>üìù Provide Correction</h2>
            <form class="correction-form" id="correctionForm">
                <div class="form-row">
                    <div>
                        <label for="correctionUserName">Your Name:</label>
                        <input type="text" id="correctionUserName" placeholder="Dr. Smith" required>
                    </div>
                    <div>
                        <label for="correctionConfidence">Confidence Level:</label>
                        <select id="correctionConfidence" required>
                            <option value="">Select confidence...</option>
                            <option value="low">Low - Minor improvement</option>
                            <option value="medium">Medium - Significant improvement</option>
                            <option value="high">High - Critical correction needed</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label>Original Exam Name:</label>
                    <div id="correctionOriginalName" style="padding: 0.5rem; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; font-weight: bold;"></div>
                </div>
                
                <div class="correction-comparison">
                    <div class="correction-original">
                        <h4>Current Parsing</h4>
                        <div id="correctionOriginalMapping"></div>
                    </div>
                    <div class="correction-corrected">
                        <h4>Your Correction</h4>
                        <div id="correctionCorrectedMapping">
                            <div class="component-editor">
                                <label for="correctedCleanName">Clean Name:</label>
                                <input type="text" id="correctedCleanName" placeholder="CT Chest with Contrast">
                            </div>
                            
                            <div class="component-editor">
                                <label>Anatomy:</label>
                                <div id="correctedAnatomyTags" class="component-tags"></div>
                                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                    <input type="text" id="correctedAnatomyInput" placeholder="Add anatomy...">
                                    <button type="button" class="add-anatomy-btn" onclick="addAnatomyTag()">Add</button>
                                </div>
                            </div>
                            
                            <div class="component-editor">
                                <label for="correctedLaterality">Laterality:</label>
                                <select id="correctedLaterality">
                                    <option value="">None</option>
                                    <option value="left">Left</option>
                                    <option value="right">Right</option>
                                    <option value="bilateral">Bilateral</option>
                                </select>
                            </div>
                            
                            <div class="component-editor">
                                <label for="correctedContrast">Contrast:</label>
                                <select id="correctedContrast">
                                    <option value="">None</option>
                                    <option value="with">With Contrast</option>
                                    <option value="without">Without Contrast</option>
                                    <option value="with and without">With and Without Contrast</option>
                                </select>
                            </div>
                            
                            <div class="component-editor">
                                <label for="correctedGenderContext">Gender Context:</label>
                                <select id="correctedGenderContext">
                                    <option value="">None</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="pregnancy">Pregnancy</option>
                                </select>
                            </div>
                            
                            <div class="component-editor">
                                <label for="correctedClinicalContext">Clinical Context:</label>
                                <select id="correctedClinicalContext">
                                    <option value="">None</option>
                                    <option value="emergency">Emergency</option>
                                    <option value="screening">Screening</option>
                                    <option value="follow-up">Follow-up</option>
                                    <option value="intervention">Intervention</option>
                                    <option value="routine">Routine</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label for="correctionNotes">Correction Notes:</label>
                    <textarea id="correctionNotes" placeholder="Explain why this correction is needed..."></textarea>
                </div>
                
                <div class="correction-buttons">
                    <button type="button" class="button secondary" onclick="closeCorrectionModal()">Cancel</button>
                    <button type="submit" class="button success">Submit Correction</button>
                </div>
            </form>
            <div id="correctionResult"></div>
        </div>
    </div>

    <script>
    window.addEventListener('DOMContentLoaded', function() {
        // --- DYNAMIC API CONFIGURATION ---
        // Local development API URL
        const LOCAL_API_URL = 'http://localhost:5000/parse_enhanced';
        const STAGING_API_URL = 'https://radiology-api-staging.onrender.com/parse_enhanced';
        const PRODUCTION_API_URL = 'https://radiology-api-prod.onrender.com/parse_enhanced';
        const PRODUCTION_HOSTNAME = 'radiology-cleaner.pages.dev'; // Use your final Cloudflare Pages production domain here.

        // Automatically select the correct API based on the frontend's URL
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const isProduction = window.location.hostname === PRODUCTION_HOSTNAME;
        const API_URL = isLocalhost ? LOCAL_API_URL : (isProduction ? PRODUCTION_API_URL : STAGING_API_URL);
        
        console.log(`Frontend running in ${isProduction ? 'PRODUCTION' : 'STAGING'} mode.`);
        console.log(`API endpoint set to: ${API_URL}`);

        // --- STATE ---
        let allMappings = [];
        let summaryData = null;

        // --- DOM ELEMENTS ---
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const resultsSection = document.getElementById('resultsSection');
        const resultsBody = document.getElementById('resultsBody');

        // --- EVENT LISTENERS ---
        uploadSection.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => e.target.files[0] && processFile(e.target.files[0]));
        ['dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadSection.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => uploadSection.addEventListener(eventName, () => uploadSection.classList.add('dragover'), false));
        ['dragleave', 'drop'].forEach(eventName => uploadSection.addEventListener(eventName, () => uploadSection.classList.remove('dragover'), false));
        uploadSection.addEventListener('drop', (e) => e.dataTransfer.files[0] && processFile(e.dataTransfer.files[0]), false);

        document.getElementById('exportMappingsBtn').addEventListener('click', exportResults);
        document.getElementById('exportSummaryBtn').addEventListener('click', exportSummary);
        document.getElementById('viewConsolidationsBtn').addEventListener('click', showConsolidationExamples);
        document.getElementById('closeModalBtn').addEventListener('click', closeModal);
        document.getElementById('consolidationModal').addEventListener('click', (e) => e.target.id === 'consolidationModal' && closeModal());
        
        // View toggle event listeners
        document.getElementById('sampleViewBtn').addEventListener('click', showSampleView);
        document.getElementById('consolidatedViewBtn').addEventListener('click', showConsolidatedView);
        document.getElementById('consolidatedSearch').addEventListener('input', filterConsolidatedResults);
        document.getElementById('consolidatedSort').addEventListener('change', sortConsolidatedResults);
        
        // Feedback system event listeners
        document.querySelectorAll('.feedback-tab').forEach(tab => {
            tab.addEventListener('click', () => switchFeedbackTab(tab.dataset.tab));
        });
        document.getElementById('generalFeedbackForm').addEventListener('submit', submitGeneralFeedback);
        document.getElementById('correctionForm').addEventListener('submit', submitCorrectionFeedback);
        document.getElementById('closeCorrectionModalBtn').addEventListener('click', closeCorrectionModal);
        document.getElementById('correctionModal').addEventListener('click', (e) => {
            if (e.target.id === 'correctionModal') closeCorrectionModal();
        });

        // Header menu event listeners
        document.getElementById('hamburgerToggle').addEventListener('click', toggleHamburgerMenu);
        document.getElementById('menuHelp').addEventListener('click', showHelpModal);
        document.getElementById('closeHelpModal').addEventListener('click', closeHelpModal);
        document.getElementById('closeHelpBtn').addEventListener('click', closeHelpModal);
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('hamburgerDropdown');
            const toggle = document.getElementById('hamburgerToggle');
            
            if (!dropdown.contains(event.target) && !toggle.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });
        document.getElementById('helpModal').addEventListener('click', (e) => {
            if (e.target.id === 'helpModal') closeHelpModal();
        });
        
        // Hamburger menu functions
        function toggleHamburgerMenu() {
            const dropdown = document.getElementById('hamburgerDropdown');
            dropdown.classList.toggle('hidden');
        }
        
        function showHelpModal() {
            // Close hamburger menu first
            document.getElementById('hamburgerDropdown').classList.add('hidden');
            
            // Populate modal with system architecture content
            const helpContent = document.getElementById('helpContent');
            helpContent.innerHTML = `
                <h2>System Architecture</h2>
                <p><strong>Overview:</strong> The Radiology Code Semantic Cleaner is an intelligent system that standardizes disparate radiology examination names into consistent, clinically meaningful clean names with associated SNOMED codes.</p>
                
                <h3>Key Features</h3>
                <ul>
                    <li><strong>Hybrid Processing:</strong> Combines NLP, Machine Learning, and rule-based logic</li>
                    <li><strong>SNOMED Integration:</strong> Maps to standardized medical terminology</li>
                    <li><strong>Fuzzy Matching:</strong> Handles variations in exam naming</li>
                    <li><strong>Clinical Equivalence:</strong> Recognizes medically equivalent terms</li>
                </ul>
                
                <h3>Processing Pipeline</h3>
                <ol>
                    <li><strong>Input Processing:</strong> JSON array of radiology codes</li>
                    <li><strong>Multi-Stage Parsing:</strong> Exact match ‚Üí Hybrid extraction ‚Üí Component merging</li>
                    <li><strong>Clean Name Generation:</strong> Standardized anatomical ordering</li>
                    <li><strong>Fuzzy Matching:</strong> Multi-metric similarity scoring</li>
                    <li><strong>SNOMED Assignment:</strong> Direct or fuzzy match assignment</li>
                </ol>
                
                <h3>Technical Components</h3>
                <ul>
                    <li><strong>NLP Module:</strong> ScispaCy for medical entity recognition</li>
                    <li><strong>ML Module:</strong> Scikit-learn with TF-IDF vectorization</li>
                    <li><strong>Rule Engine:</strong> Pattern matching and dictionary lookups</li>
                    <li><strong>Database:</strong> 4,986 SNOMED reference entries</li>
                </ul>
                
                <h3>Performance Metrics</h3>
                <ul>
                    <li><strong>Processing Speed:</strong> ~45ms average response time</li>
                    <li><strong>Accuracy:</strong> 85-90% anatomical detection accuracy</li>
                    <li><strong>Throughput:</strong> ~1,000 exams per minute</li>
                    <li><strong>SNOMED Matching:</strong> 15-20% exact matches, 60-70% high-quality fuzzy matches</li>
                </ul>
                
                <h3>Usage Instructions</h3>
                <ol>
                    <li>Upload a JSON file containing radiology exam data</li>
                    <li>Required fields: EXAM_NAME, MODALITY_CODE, DATA_SOURCE, EXAM_CODE</li>
                    <li>The system will process and return standardized clean names</li>
                    <li>Review results and download the processed data</li>
                </ol>
                
                <div style="margin-top: 2rem; padding: 1rem; background: var(--color-primary-light); border-radius: var(--radius-base); border-left: 4px solid var(--color-primary);">
                    <p><strong>Note:</strong> This system is designed for healthcare professionals to standardize radiology examination terminology. For detailed technical documentation, refer to the full system architecture document.</p>
                </div>
            `;
            
            // Show modal
            document.getElementById('helpModal').style.display = 'block';
        }
        
        function closeHelpModal() {
            document.getElementById('helpModal').style.display = 'none';
        }

        // --- CORE LOGIC ---
        async function processFile(file) {
            if (!file.name.endsWith('.json')) {
                alert('Please upload a valid JSON file.');
                return;
            }

            fileInfo.innerHTML = `<strong>File loaded:</strong> ${file.name} (${formatFileSize(file.size)})`;
            fileInfo.style.display = 'block';
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';
            resultsSection.style.display = 'none';
            allMappings = [];
            summaryData = null;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const codes = JSON.parse(e.target.result);
                    for (let i = 0; i < codes.length; i++) {
                        const code = codes[i];
                        try {
                            const response = await fetch(API_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ exam_name: code.EXAM_NAME, modality_code: code.MODALITY_CODE })
                            });
                            if (!response.ok) throw new Error(`API returned status ${response.status}`);
                            
                            const parsed = await response.json();
                            allMappings.push({
                                data_source: code.DATA_SOURCE,
                                modality_code: code.MODALITY_CODE,
                                exam_code: code.EXAM_CODE,
                                exam_name: code.EXAM_NAME,
                                clean_name: parsed.standardized.clean_name,
                                snomed: parsed.snomed || {},
                                components: { 
                                    anatomy: parsed.standardized.components.anatomy, 
                                    laterality: parsed.standardized.components.laterality, 
                                    contrast: parsed.standardized.components.contrast, 
                                    technique: parsed.standardized.components.technique,
                                    gender_context: parsed.standardized.components.gender_context,
                                    clinical_context: parsed.standardized.components.clinical_context,
                                    confidence: parsed.metadata.confidence,
                                    clinical_equivalents: parsed.equivalence.clinical_equivalents
                                }
                            });
                        } catch (error) {
                            console.error(`Failed to parse code: ${code.EXAM_NAME}`, error);
                            allMappings.push({ ...code, clean_name: 'ERROR - PARSING FAILED', components: {} });
                        }
                        progressFill.style.width = `${((i + 1) / codes.length) * 100}%`;
                    }
                    runAnalysis(allMappings);
                } catch (error) {
                    alert('Error reading or parsing JSON file: ' + error.message);
                    progressBar.style.display = 'none';
                }
            };
            reader.readAsText(file);
        }

        function runAnalysis(mappings) {
            summaryData = generateAnalyticsSummary(mappings);
            updateStatsUI(summaryData);
            displaySampleResults(mappings.slice(0, 100));
            generateConsolidatedResults(mappings);
            resultsSection.style.display = 'block';
        }

        // --- UI & DISPLAY FUNCTIONS ---
        function updateStatsUI(summary) {
            document.getElementById('originalCount').textContent = summary.totalOriginalCodes;
            document.getElementById('cleanCount').textContent = summary.uniqueCleanNames;
            document.getElementById('consolidationRatio').textContent = `${summary.consolidationRatio}:1`;
            document.getElementById('modalityCount').textContent = Object.keys(summary.modalityBreakdown).length;
            document.getElementById('avgConfidence').textContent = `${summary.avgConfidence}%`;
            document.getElementById('genderContext').textContent = summary.genderContextCount;
        }

        function displaySampleResults(samples) {
            resultsBody.innerHTML = '';
            samples.forEach(item => {
                const row = resultsBody.insertRow();
                row.insertCell().textContent = item.data_source;
                row.insertCell().textContent = item.exam_code;
                row.insertCell().textContent = item.exam_name;
                const cleanNameCell = row.insertCell();
                if (item.clean_name.startsWith('ERROR')) {
                    cleanNameCell.innerHTML = `<span class="error-message">${item.clean_name}</span>`;
                } else {
                    cleanNameCell.innerHTML = `<strong>${item.clean_name}</strong>`;
                }

                // Add SNOMED Code cell
                const snomedCodeCell = row.insertCell();
                if (item.snomed && item.snomed.snomed_concept_id) {
                    snomedCodeCell.textContent = item.snomed.snomed_concept_id;
                } else {
                    snomedCodeCell.innerHTML = '<span style="color: #999;">-</span>';
                }

                // Add SNOMED FSN cell
                const snomedFsnCell = row.insertCell();
                if (item.snomed && item.snomed.snomed_fsn) {
                    snomedFsnCell.textContent = item.snomed.snomed_fsn;
                } else {
                    snomedFsnCell.innerHTML = '<span style="color: #999;">-</span>';
                }

                const componentsCell = row.insertCell();
                const { anatomy, laterality, contrast, technique } = item.components;
                if(anatomy) anatomy.forEach(a => componentsCell.innerHTML += `<span class="tag anatomy">${a}</span>`);
                if(laterality) componentsCell.innerHTML += `<span class="tag laterality">${laterality}</span>`;
                if(contrast) componentsCell.innerHTML += `<span class="tag contrast">${contrast}</span>`;
                if(technique) technique.forEach(t => componentsCell.innerHTML += `<span class="tag technique">${t}</span>`);
                
                // Add context cell
                const contextCell = row.insertCell();
                const { gender_context, clinical_context, clinical_equivalents } = item.components;
                if(gender_context) contextCell.innerHTML += `<span class="tag gender">${gender_context}</span>`;
                if(clinical_context) clinical_context.forEach(c => contextCell.innerHTML += `<span class="tag clinical">${c}</span>`);
                if(clinical_equivalents && clinical_equivalents.length > 0) {
                    clinical_equivalents.slice(0, 2).forEach(e => contextCell.innerHTML += `<span class="tag equivalent">${e}</span>`);
                }
                
                // Add confidence cell
                const confidenceCell = row.insertCell();
                const confidence = item.components.confidence || 0;
                const confidencePercent = Math.round(confidence * 100);
                const confidenceClass = confidence >= 0.8 ? 'confidence-high' : confidence >= 0.6 ? 'confidence-medium' : 'confidence-low';
                confidenceCell.innerHTML = `
                    <div class="confidence-bar">
                        <div class="confidence-fill ${confidenceClass}" style="width: ${confidencePercent}%"></div>
                    </div>
                    <small>${confidencePercent}%</small>
                `;
            });
        }

        // --- UTILITY & EXPORT FUNCTIONS ---
        function generateAnalyticsSummary(mappings) {
            const summary = {
                totalOriginalCodes: mappings.length,
                uniqueCleanNames: new Set(mappings.map(m => m.clean_name).filter(n => !n.startsWith('ERROR'))).size,
                modalityBreakdown: {}, 
                contrastUsage: { with: 0, without: 0, 'with and without': 0, none: 0 },
                lateralityDistribution: { left: 0, right: 0, bilateral: 0, none: 0 },
                genderContextBreakdown: { male: 0, female: 0, pregnancy: 0, none: 0 },
                clinicalContextBreakdown: { emergency: 0, screening: 0, follow_up: 0, intervention: 0, none: 0 },
                avgConfidence: 0,
                genderContextCount: 0
            };
            summary.consolidationRatio = summary.uniqueCleanNames > 0 ? (summary.totalOriginalCodes / summary.uniqueCleanNames).toFixed(2) : "0.00";
            
            const cleanNameGroups = {};
            let totalConfidence = 0;
            let confidenceCount = 0;
            
            mappings.forEach(m => {
                if (!m.components || m.clean_name.startsWith('ERROR')) return;
                const { modality_code, components } = m;
                const modality = m.components.modality || modality_code;
                if (modality) summary.modalityBreakdown[modality] = (summary.modalityBreakdown[modality] || 0) + 1;
                
                const contrastType = (components.contrast || 'none').replace(' ', '_');
                if(summary.contrastUsage.hasOwnProperty(contrastType)) summary.contrastUsage[contrastType]++;
                
                const laterality = (components.laterality || 'none').toLowerCase();
                if(summary.lateralityDistribution.hasOwnProperty(laterality)) summary.lateralityDistribution[laterality]++;
                
                // Enhanced analytics
                const genderContext = components.gender_context || 'none';
                if(summary.genderContextBreakdown.hasOwnProperty(genderContext)) {
                    summary.genderContextBreakdown[genderContext]++;
                    if(genderContext !== 'none') summary.genderContextCount++;
                }
                
                const clinicalContexts = components.clinical_context || [];
                if(clinicalContexts.length > 0) {
                    clinicalContexts.forEach(context => {
                        if(summary.clinicalContextBreakdown.hasOwnProperty(context)) {
                            summary.clinicalContextBreakdown[context]++;
                        }
                    });
                } else {
                    summary.clinicalContextBreakdown.none++;
                }
                
                if(components.confidence !== undefined) {
                    totalConfidence += components.confidence;
                    confidenceCount++;
                }

                if (!cleanNameGroups[m.clean_name]) cleanNameGroups[m.clean_name] = [];
                cleanNameGroups[m.clean_name].push(m);
            });
            
            summary.avgConfidence = confidenceCount > 0 ? Math.round((totalConfidence / confidenceCount) * 100) : 0;
            summary.topConsolidatedExams = Object.entries(cleanNameGroups)
                .filter(([, group]) => group.length > 1).sort((a, b) => b[1].length - a[1].length).slice(0, 10)
                .map(([cleanName, group]) => ({
                    cleanName, originalCount: group.length,
                    examples: group.slice(0, 3).map(m => ({ source: m.data_source, code: m.exam_code, name: m.exam_name }))
                }));
            return summary;
        }

        function exportResults() {
            if (!allMappings.length) return alert('No data to export.');
            downloadJSON(allMappings, 'radiology_codes_cleaned.json');
        }

        function exportSummary() {
            if (!summaryData) return alert('No summary to export.');
            let report = `ENHANCED RADIOLOGY CODE CLEANING SUMMARY\n========================================\n`;
            report += `Total Original Codes: ${summaryData.totalOriginalCodes}\n`;
            report += `Unique Clean Names: ${summaryData.uniqueCleanNames}\n`;
            report += `Consolidation Ratio: ${summaryData.consolidationRatio}:1\n`;
            report += `Average Confidence: ${summaryData.avgConfidence}%\n`;
            report += `Gender Context Detected: ${summaryData.genderContextCount} codes\n\n`;
            
            report += `GENDER CONTEXT BREAKDOWN\n-----------------------\n`;
            Object.entries(summaryData.genderContextBreakdown).forEach(([context, count]) => {
                if(count > 0) report += `${context}: ${count}\n`;
            });
            
            report += `\nCLINICAL CONTEXT BREAKDOWN\n-------------------------\n`;
            Object.entries(summaryData.clinicalContextBreakdown).forEach(([context, count]) => {
                if(count > 0) report += `${context}: ${count}\n`;
            });
            
            report += `\nTOP CONSOLIDATED EXAMS\n----------------------\n`;
            summaryData.topConsolidatedExams.forEach(exam => {
                report += `\n"${exam.cleanName}" (${exam.originalCount} codes)\n`;
                exam.examples.forEach(ex => report += `   - [${ex.source}] ${ex.code}: ${ex.name}\n`);
            });
            downloadText(report, 'enhanced_radiology_cleaning_summary.txt');
        }
        
        function showConsolidationExamples() {
            if (!summaryData || !summaryData.topConsolidatedExams.length) return alert('No consolidation data available.');
            const examplesDiv = document.getElementById('consolidationExamples');
            examplesDiv.innerHTML = '';
            summaryData.topConsolidatedExams.forEach(exam => {
                const card = document.createElement('div');
                card.className = 'example-card';
                card.innerHTML = `<h4>${exam.cleanName} (${exam.originalCount} original codes)</h4>
                                  <div class="original-codes">
                                      ${exam.examples.map(ex => `‚Ä¢ [${ex.source}] ${ex.code}: "${ex.name}"`).join('<br>')}
                                      ${exam.originalCount > 3 ? `<br>‚Ä¢ ... and ${exam.originalCount - 3} more` : ''}
                                  </div>`;
                examplesDiv.appendChild(card);
            });
            document.getElementById('consolidationModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('consolidationModal').style.display = 'none'; }
        
        // --- CONSOLIDATED VIEW FUNCTIONS ---
        let consolidatedData = [];
        let filteredConsolidatedData = [];
        
        function generateConsolidatedResults(mappings) {
            const consolidatedGroups = {};
            
            // Group mappings by clean name
            mappings.forEach(mapping => {
                if (mapping.clean_name.startsWith('ERROR')) return;
                
                const cleanName = mapping.clean_name;
                if (!consolidatedGroups[cleanName]) {
                    consolidatedGroups[cleanName] = {
                        cleanName: cleanName,
                        sourceCodes: [],
                        totalCount: 0,
                        avgConfidence: 0,
                        components: mapping.components,
                        dataSources: new Set(),
                        modalities: new Set()
                    };
                }
                
                consolidatedGroups[cleanName].sourceCodes.push({
                    dataSource: mapping.data_source,
                    examCode: mapping.exam_code,
                    examName: mapping.exam_name,
                    confidence: mapping.components.confidence || 0
                });
                
                consolidatedGroups[cleanName].totalCount++;
                consolidatedGroups[cleanName].dataSources.add(mapping.data_source);
                consolidatedGroups[cleanName].modalities.add(mapping.modality_code);
            });
            
            // Calculate average confidence for each group
            Object.values(consolidatedGroups).forEach(group => {
                const totalConfidence = group.sourceCodes.reduce((sum, code) => sum + code.confidence, 0);
                group.avgConfidence = totalConfidence / group.sourceCodes.length;
            });
            
            consolidatedData = Object.values(consolidatedGroups);
            filteredConsolidatedData = [...consolidatedData];
            sortConsolidatedResults();
        }
        
        function showSampleView() {
            document.getElementById('sampleView').style.display = 'block';
            document.getElementById('consolidatedView').style.display = 'none';
            document.getElementById('sampleViewBtn').classList.add('active');
            document.getElementById('consolidatedViewBtn').classList.remove('active');
        }
        
        function showConsolidatedView() {
            document.getElementById('sampleView').style.display = 'none';
            document.getElementById('consolidatedView').style.display = 'block';
            document.getElementById('sampleViewBtn').classList.remove('active');
            document.getElementById('consolidatedViewBtn').classList.add('active');
            displayConsolidatedResults();
        }
        
        function displayConsolidatedResults() {
            const container = document.getElementById('consolidatedResults');
            container.innerHTML = '';
            
            filteredConsolidatedData.forEach(group => {
                const groupElement = document.createElement('div');
                groupElement.className = 'consolidated-group';
                
                const confidencePercent = Math.round(group.avgConfidence * 100);
                const confidenceClass = group.avgConfidence >= 0.8 ? 'confidence-high' : 
                                       group.avgConfidence >= 0.6 ? 'confidence-medium' : 'confidence-low';
                
                groupElement.innerHTML = `
                    <div class="consolidated-header">
                        <div class="consolidated-title">${group.cleanName}</div>
                        <div class="consolidated-count">${group.totalCount} codes</div>
                    </div>
                    <div class="consolidated-body">
                        <div class="consolidated-meta">
                            <div><strong>Sources:</strong> ${Array.from(group.dataSources).join(', ')}</div>
                            <div><strong>Modalities:</strong> ${Array.from(group.modalities).join(', ')}</div>
                            <div><strong>Avg Confidence:</strong> 
                                <span class="confidence-bar">
                                    <span class="confidence-fill ${confidenceClass}" style="width: ${confidencePercent}%"></span>
                                </span>
                                ${confidencePercent}%
                            </div>
                        </div>
                        <div class="consolidated-components">
                            ${generateComponentTags(group.components)}
                        </div>
                        <div class="source-codes">
                            ${group.sourceCodes.map(code => `
                                <div class="source-code">
                                    <div class="source-code-header">
                                        <span>[${code.dataSource}] ${code.examCode}</span>
                                        <button class="feedback-button" onclick="openCorrectionModal({
                                            exam_name: '${code.examName}',
                                            clean_name: '${group.cleanName}',
                                            components: ${JSON.stringify(group.components).replace(/"/g, '&quot;')}
                                        })">Provide Feedback</button>
                                    </div>
                                    <div class="source-code-name">${code.examName}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                container.appendChild(groupElement);
            });
        }
        
        function generateComponentTags(components) {
            let tags = '';
            
            if (components.anatomy) {
                components.anatomy.forEach(a => tags += `<span class="tag anatomy">${a}</span>`);
            }
            if (components.laterality) {
                tags += `<span class="tag laterality">${components.laterality}</span>`;
            }
            if (components.contrast) {
                tags += `<span class="tag contrast">${components.contrast}</span>`;
            }
            if (components.technique) {
                components.technique.forEach(t => tags += `<span class="tag technique">${t}</span>`);
            }
            if (components.gender_context) {
                tags += `<span class="tag gender">${components.gender_context}</span>`;
            }
            if (components.clinical_context) {
                components.clinical_context.forEach(c => tags += `<span class="tag clinical">${c}</span>`);
            }
            
            return tags;
        }
        
        function filterConsolidatedResults() {
            const searchTerm = document.getElementById('consolidatedSearch').value.toLowerCase();
            
            if (searchTerm === '') {
                filteredConsolidatedData = [...consolidatedData];
            } else {
                filteredConsolidatedData = consolidatedData.filter(group => 
                    group.cleanName.toLowerCase().includes(searchTerm) ||
                    group.sourceCodes.some(code => 
                        code.examName.toLowerCase().includes(searchTerm) ||
                        code.examCode.toLowerCase().includes(searchTerm)
                    )
                );
            }
            
            sortConsolidatedResults();
        }
        
        function sortConsolidatedResults() {
            const sortBy = document.getElementById('consolidatedSort').value;
            
            filteredConsolidatedData.sort((a, b) => {
                switch (sortBy) {
                    case 'count':
                        return b.totalCount - a.totalCount;
                    case 'name':
                        return a.cleanName.localeCompare(b.cleanName);
                    case 'confidence':
                        return b.avgConfidence - a.avgConfidence;
                    default:
                        return b.totalCount - a.totalCount;
                }
            });
            
            displayConsolidatedResults();
        }
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024, sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
        }
        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            triggerDownload(blob, filename);
        }
        function downloadText(text, filename) {
            const blob = new Blob([text], { type: 'text/plain' });
            triggerDownload(blob, filename);
        }
        function triggerDownload(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // --- FEEDBACK SYSTEM FUNCTIONS ---
        
        function switchFeedbackTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.feedback-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update panels
            document.querySelectorAll('.feedback-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(`${tabName}FeedbackPanel`).classList.add('active');
        }
        
        async function submitGeneralFeedback(e) {
            e.preventDefault();
            
            const formData = {
                type: 'general',
                user_name: document.getElementById('generalUserName').value,
                suggestion_text: document.getElementById('generalSuggestion').value,
                confidence_level: document.getElementById('generalConfidence').value,
                notes: document.getElementById('generalNotes').value
            };
            
            try {
                const response = await fetch(API_URL.replace('/parse', '/feedback'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                const resultDiv = document.getElementById('generalFeedbackResult');
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="feedback-success">
                        <strong>Thank you!</strong> Your suggestion has been submitted successfully. 
                        Reference ID: ${result.feedback_id}
                    </div>`;
                    
                    // Reset form
                    document.getElementById('generalFeedbackForm').reset();
                } else {
                    resultDiv.innerHTML = `<div class="feedback-error">
                        <strong>Error:</strong> ${result.error || 'Failed to submit feedback'}
                    </div>`;
                }
            } catch (error) {
                console.error('Feedback submission error:', error);
                document.getElementById('generalFeedbackResult').innerHTML = `<div class="feedback-error">
                    <strong>Error:</strong> Unable to submit feedback. Please try again.
                </div>`;
            }
        }
        
        let currentCorrectionData = null;
        
        function openCorrectionModal(originalData) {
            currentCorrectionData = originalData;
            
            // Populate original data
            document.getElementById('correctionOriginalName').textContent = originalData.exam_name;
            
            // Display current parsing
            const originalMapping = document.getElementById('correctionOriginalMapping');
            originalMapping.innerHTML = `
                <div><strong>Clean Name:</strong> ${originalData.clean_name}</div>
                <div><strong>Components:</strong> ${generateComponentTags(originalData.components)}</div>
                <div><strong>Confidence:</strong> ${Math.round(originalData.components.confidence * 100)}%</div>
            `;
            
            // Pre-populate correction form with current values
            document.getElementById('correctedCleanName').value = originalData.clean_name;
            document.getElementById('correctedLaterality').value = originalData.components.laterality || '';
            document.getElementById('correctedContrast').value = originalData.components.contrast || '';
            document.getElementById('correctedGenderContext').value = originalData.components.gender_context || '';
            document.getElementById('correctedClinicalContext').value = originalData.components.clinical_context?.[0] || '';
            
            // Populate anatomy tags
            updateAnatomyTags(originalData.components.anatomy || []);
            
            // Show modal
            document.getElementById('correctionModal').style.display = 'block';
        }
        
        function closeCorrectionModal() {
            document.getElementById('correctionModal').style.display = 'none';
            currentCorrectionData = null;
            
            // Clear form
            document.getElementById('correctionForm').reset();
            document.getElementById('correctionResult').innerHTML = '';
            document.getElementById('correctedAnatomyTags').innerHTML = '';
        }
        
        let correctedAnatomy = [];
        
        function updateAnatomyTags(anatomy) {
            correctedAnatomy = [...anatomy];
            const container = document.getElementById('correctedAnatomyTags');
            container.innerHTML = '';
            
            correctedAnatomy.forEach((item, index) => {
                const tag = document.createElement('span');
                tag.className = 'editable-tag';
                tag.innerHTML = `${item} <span onclick="removeAnatomyTag(${index})" style="cursor: pointer; margin-left: 4px;">√ó</span>`;
                container.appendChild(tag);
            });
        }
        
        function addAnatomyTag() {
            const input = document.getElementById('correctedAnatomyInput');
            const value = input.value.trim();
            
            if (value && !correctedAnatomy.includes(value)) {
                correctedAnatomy.push(value);
                updateAnatomyTags(correctedAnatomy);
                input.value = '';
            }
        }
        
        function removeAnatomyTag(index) {
            correctedAnatomy.splice(index, 1);
            updateAnatomyTags(correctedAnatomy);
        }
        
        // Make addAnatomyTag globally accessible
        window.addAnatomyTag = addAnatomyTag;
        window.removeAnatomyTag = removeAnatomyTag;
        
        async function submitCorrectionFeedback(e) {
            e.preventDefault();
            
            if (!currentCorrectionData) return;
            
            const correctedMapping = {
                cleanName: document.getElementById('correctedCleanName').value,
                anatomy: correctedAnatomy,
                laterality: document.getElementById('correctedLaterality').value || null,
                contrast: document.getElementById('correctedContrast').value || null,
                technique: currentCorrectionData.components.technique || [],
                gender_context: document.getElementById('correctedGenderContext').value || null,
                clinical_context: document.getElementById('correctedClinicalContext').value ? 
                    [document.getElementById('correctedClinicalContext').value] : [],
                confidence: currentCorrectionData.components.confidence
            };
            
            const formData = {
                type: 'correction',
                user_name: document.getElementById('correctionUserName').value,
                original_exam_name: currentCorrectionData.exam_name,
                original_mapping: currentCorrectionData.components,
                corrected_mapping: correctedMapping,
                confidence_level: document.getElementById('correctionConfidence').value,
                notes: document.getElementById('correctionNotes').value
            };
            
            try {
                const response = await fetch(API_URL.replace('/parse', '/feedback'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                const resultDiv = document.getElementById('correctionResult');
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="feedback-success">
                        <strong>Thank you!</strong> Your correction has been submitted successfully. 
                        Reference ID: ${result.feedback_id}
                    </div>`;
                    
                    // Auto-close modal after 3 seconds
                    setTimeout(() => closeCorrectionModal(), 3000);
                } else {
                    resultDiv.innerHTML = `<div class="feedback-error">
                        <strong>Error:</strong> ${result.error || 'Failed to submit correction'}
                    </div>`;
                }
            } catch (error) {
                console.error('Correction submission error:', error);
                document.getElementById('correctionResult').innerHTML = `<div class="feedback-error">
                    <strong>Error:</strong> Unable to submit correction. Please try again.
                </div>`;
            }
        }
        
        // Make correction functions globally accessible
        window.openCorrectionModal = openCorrectionModal;
        window.closeCorrectionModal = closeCorrectionModal;
    });
    </script>
</body>
</html>
