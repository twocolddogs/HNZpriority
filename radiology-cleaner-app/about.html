<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Architecture - Radiology Code Semantic Cleaner</title>
    <!-- Fonts -->
    <link href="./fonts/poppins.css" rel="stylesheet" type="text/css">
    <link href="./fonts/publicsans.css" rel="stylesheet" type="text/css">
    <!-- Unified Design System -->
    <link href="./unified-styles.css" rel="stylesheet" type="text/css">
    <style>
        .about-page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .about-content {
            background: white;
            border-radius: 8px;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .about-nav {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 30px;
        }
        .about-nav a {
            color: #3f51b5;
            text-decoration: none;
            font-weight: 500;
        }
        .about-nav a:hover {
            text-decoration: underline;
        }
        .architecture-section {
            margin-bottom: 40px;
        }
        .architecture-section h2 {
            color: #333;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .architecture-section h3 {
            color: #555;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        .architecture-section p {
            line-height: 1.6;
            margin-bottom: 15px;
        }
        .architecture-section ul, .architecture-section ol {
            line-height: 1.6;
            margin-bottom: 15px;
            padding-left: 25px;
        }
        .architecture-section li {
            margin-bottom: 8px;
        }
        .tech-stack {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .tech-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
        }
        .tech-item h4 {
            color: #3f51b5;
            margin: 0 0 10px 0;
        }
        .pipeline-flow {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .model-comparison {
            background: #fafafa;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        .model-comparison table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .model-comparison th,
        .model-comparison td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .model-comparison th {
            background: #f0f0f0;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="app-header">
            <div class="brand-bar">
                <div class="brand-content">
                    <img src="./images/HealthNZ_logo_v2.svg" alt="Health New Zealand Logo" class="app-logo">
                    <div class="header-divider"></div>
                    <div class="brand-text">
                        <h1 class="brand-title">System Architecture</h1>
                        <p class="brand-subtitle">How the Radiology Code Semantic Cleaner Works</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="about-page">
            <div class="about-nav">
                <a href="index.html">‚Üê Back to Main Application</a> | 
                <a href="help.html">Help & Documentation</a>
            </div>

            <div class="about-content">
                <div class="architecture-section">
                    <h2>üèóÔ∏è System Overview</h2>
                    <p>The Radiology Code Semantic Cleaner is a sophisticated AI-powered system that standardizes radiology exam names using a two-stage pipeline: <strong>retrieval</strong> and <strong>reranking</strong>.</p>
                    
                    <div class="info-box">
                        <strong>üéØ Primary Goal:</strong> Transform inconsistent radiology exam names into standardized NHS reference terms with high accuracy and confidence scoring.
                    </div>

                    <div class="pipeline-flow">
Input: "CT CHEST W/ CONTRAST"
  ‚Üì
1. Preprocessing & Component Extraction
  ‚Üì
2. Semantic Retrieval (BioLORD/Default)
  ‚Üì
3. Candidate Reranking (MedCPT/OpenRouter)
  ‚Üì
4. Confidence Scoring & Final Selection
  ‚Üì
Output: "CT Chest with IV Contrast" (95% confidence)
                    </div>
                </div>

                <div class="architecture-section">
                    <h2>üîß Technical Architecture</h2>
                    
                    <h3>Frontend (Client-Side)</h3>
                    <ul>
                        <li><strong>Framework:</strong> Pure JavaScript with ES6 modules</li>
                        <li><strong>UI Components:</strong> React-like components using createElement</li>
                        <li><strong>State Management:</strong> Local state with localStorage persistence</li>
                        <li><strong>Styling:</strong> Unified CSS design system</li>
                        <li><strong>File Processing:</strong> Client-side JSON parsing and validation</li>
                    </ul>

                    <h3>Backend (Server-Side)</h3>
                    <ul>
                        <li><strong>Framework:</strong> Flask (Python)</li>
                        <li><strong>Deployment:</strong> Render.com with auto-scaling</li>
                        <li><strong>Storage:</strong> Cloudflare R2 for configuration and results</li>
                        <li><strong>Processing:</strong> Multi-threaded batch processing</li>
                        <li><strong>APIs:</strong> RESTful endpoints with CORS support</li>
                    </ul>

                    <h3>AI/ML Components</h3>
                    <div class="tech-stack">
                        <div class="tech-item">
                            <h4>üîç Retrieval Models</h4>
                            <p><strong>BioLORD:</strong> Biomedical language representation model optimized for medical terminology</p>
                        </div>
                        <div class="tech-item">
                            <h4>üéØ Reranking Models</h4>
                            <p><strong>MedCPT:</strong> Medical cross-encoder via HuggingFace API</p>
                            <p><strong>OpenRouter:</strong> GPT-4, Claude, Gemini via unified API</p>
                        </div>
                    </div>
                </div>

                <div class="architecture-section">
                    <h2>üß† Processing Pipeline</h2>
                    
                    <h3>Stage 1: Preprocessing</h3>
                    <ol>
                        <li><strong>Text Normalization:</strong> Clean and standardize input text</li>
                        <li><strong>Component Extraction:</strong> Identify anatomy, modality, contrast, laterality</li>
                        <li><strong>Context Detection:</strong> Recognize gender, age, and clinical context</li>
                        <li><strong>Abbreviation Expansion:</strong> Convert common medical abbreviations</li>
                    </ol>

                    <h3>Stage 2: Semantic Retrieval</h3>
                    <ol>
                        <li><strong>Embedding Generation:</strong> Convert input to vector representation</li>
                        <li><strong>Similarity Search:</strong> Find top candidates from NHS database</li>
                        <li><strong>Filtering:</strong> Apply modality and context filters</li>
                        <li><strong>Candidate Selection:</strong> Return top N most similar matches</li>
                    </ol>

                    <h3>Stage 3: Intelligent Reranking</h3>
                    <ol>
                        <li><strong>Cross-Encoder Scoring:</strong> Deep semantic understanding of query-candidate pairs</li>
                        <li><strong>Component Alignment:</strong> Weight matching of extracted components</li>
                        <li><strong>Medical Logic:</strong> Apply domain-specific scoring rules</li>
                        <li><strong>Final Ranking:</strong> Combine scores with weighted fusion</li>
                    </ol>

                    <h3>Stage 4: Post-Processing</h3>
                    <ol>
                        <li><strong>Confidence Calculation:</strong> Generate reliability scores</li>
                        <li><strong>SNOMED Mapping:</strong> Link to standardized terminology</li>
                        <li><strong>Quality Validation:</strong> Apply consistency checks</li>
                        <li><strong>Result Formatting:</strong> Structure output for consumption</li>
                    </ol>
                </div>

                <div class="architecture-section">
                    <h2>üìä Model Comparison</h2>
                    
                    <div class="model-comparison">
                        <h3>Reranker Model Characteristics</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Model</th>
                                    <th>Type</th>
                                    <th>Strengths</th>
                                    <th>Best Use Case</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>MedCPT</strong></td>
                                    <td>Cross-Encoder</td>
                                    <td>Medical domain expertise, high accuracy</td>
                                    <td>Production processing, maximum accuracy</td>
                                </tr>
                                <tr>
                                    <td><strong>GPT-4</strong></td>
                                    <td>LLM</td>
                                    <td>Contextual understanding, reasoning</td>
                                    <td>Complex cases, edge scenarios</td>
                                </tr>
                                <tr>
                                    <td><strong>Claude</strong></td>
                                    <td>LLM</td>
                                    <td>Careful analysis, detailed explanations</td>
                                    <td>Quality review, explanation generation</td>
                                </tr>
                                <tr>
                                    <td><strong>Gemini</strong></td>
                                    <td>LLM</td>
                                    <td>Fast processing, good balance</td>
                                    <td>High-volume processing, cost efficiency</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="architecture-section">
                    <h2>üîÑ Data Flow</h2>
                    
                    <h3>Input Processing</h3>
                    <ol>
                        <li>User uploads JSON file via drag-and-drop interface</li>
                        <li>Client validates file format and structure</li>
                        <li>Data sent to backend via batch API endpoint</li>
                        <li>Server processes in chunks of 10 with progress tracking</li>
                    </ol>

                    <h3>Storage & Caching</h3>
                    <ul>
                        <li><strong>Configuration:</strong> YAML files stored in Cloudflare R2</li>
                        <li><strong>Results:</strong> Large datasets stored in R2 with public URLs</li>
                        <li><strong>Progress:</strong> Real-time progress files for batch tracking</li>
                        <li><strong>Cache:</strong> NHS reference data cached for performance</li>
                    </ul>

                    <h3>API Endpoints</h3>
                    <ul>
                        <li><code>/health</code> - System health check</li>
                        <li><code>/models</code> - Available AI models and status</li>
                        <li><code>/parse_enhanced</code> - Single exam processing</li>
                        <li><code>/parse_batch</code> - Batch processing with progress</li>
                        <li><code>/batch_progress/{id}</code> - Progress tracking</li>
                        <li><code>/config/current</code> - Configuration management</li>
                    </ul>
                </div>

                <div class="architecture-section">
                    <h2>‚öôÔ∏è Configuration System</h2>
                    
                    <h3>Dynamic Configuration</h3>
                    <p>The system uses YAML configuration files stored in Cloudflare R2 for:</p>
                    <ul>
                        <li><strong>Model Weights:</strong> Retriever vs reranker score balancing</li>
                        <li><strong>Confidence Thresholds:</strong> Quality control parameters</li>
                        <li><strong>Component Scoring:</strong> Anatomy, modality, contrast weights</li>
                        <li><strong>NHS Reference Data:</strong> Source mappings and filtering rules</li>
                    </ul>

                    <h3>Real-Time Updates</h3>
                    <p>Configuration changes trigger automatic cache rebuilding, allowing for:</p>
                    <ul>
                        <li>A/B testing of different model configurations</li>
                        <li>Performance tuning based on accuracy metrics</li>
                        <li>Domain-specific customization for different hospitals</li>
                        <li>Rapid deployment of improvements without code changes</li>
                    </ul>

                    <div class="warning-box">
                        <strong>‚ö†Ô∏è Important:</strong> Configuration changes affect all subsequent processing. Always test changes with the 100 exam test suite before production use.
                    </div>
                </div>

                <div class="architecture-section">
                    <h2>üöÄ Performance & Scalability</h2>
                    
                    <h3>Optimization Strategies</h3>
                    <ul>
                        <li><strong>Batch Processing:</strong> Process multiple exams concurrently</li>
                        <li><strong>Chunked Processing:</strong> Break large datasets into manageable pieces</li>
                        <li><strong>Progress Tracking:</strong> Real-time feedback for long-running jobs</li>
                        <li><strong>Model Caching:</strong> Pre-load embeddings and models</li>
                        <li><strong>Result Streaming:</strong> Write results to disk as they're processed</li>
                    </ul>

                    <h3>Scalability Features</h3>
                    <ul>
                        <li><strong>Auto-scaling:</strong> Render.com handles traffic spikes</li>
                        <li><strong>CDN Distribution:</strong> Cloudflare for global performance</li>
                        <li><strong>Async Processing:</strong> Non-blocking operations where possible</li>
                        <li><strong>Resource Management:</strong> Memory-efficient processing</li>
                    </ul>
                </div>

                <div class="architecture-section">
                    <h2>üîê Security & Compliance</h2>
                    
                    <h3>Data Protection</h3>
                    <ul>
                        <li><strong>HTTPS:</strong> All communications encrypted in transit</li>
                        <li><strong>CORS:</strong> Restricted cross-origin access</li>
                        <li><strong>Input Validation:</strong> Sanitization of all user inputs</li>
                        <li><strong>No PHI Storage:</strong> No personally identifiable health information stored</li>
                    </ul>

                    <h3>Healthcare Compliance</h3>
                    <ul>
                        <li><strong>Audit Logging:</strong> All processing activities logged</li>
                        <li><strong>Version Control:</strong> Configuration changes tracked</li>
                        <li><strong>Quality Assurance:</strong> Built-in testing frameworks</li>
                        <li><strong>Access Control:</strong> Configuration editing restricted</li>
                    </ul>
                </div>

                <div class="architecture-section">
                    <h2>üîó Integration Points</h2>
                    
                    <h3>External APIs</h3>
                    <ul>
                        <li><strong>HuggingFace:</strong> MedCPT model inference</li>
                        <li><strong>OpenRouter:</strong> LLM access (GPT, Claude, Gemini)</li>
                        <li><strong>Cloudflare R2:</strong> Configuration and result storage</li>
                        <li><strong>NHS TRUD:</strong> Reference terminology source</li>
                    </ul>

                    <h3>Data Sources</h3>
                    <ul>
                        <li><strong>NHS Reference Data:</strong> Standardized exam terminology</li>
                        <li><strong>SNOMED CT:</strong> Medical concept identifiers</li>
                        <li><strong>Local Mappings:</strong> Hospital-specific terminology</li>
                        <li><strong>Training Data:</strong> Validated exam name pairs</li>
                    </ul>

                    <div class="info-box">
                        <strong>üîó Quick Links:</strong><br>
                        <a href="help.html">Help & Documentation</a> | 
                        <a href="index.html">Main Application</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>