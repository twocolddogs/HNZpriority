<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scenario Configurator</title>
  <style>
    /* General Body & Font Styling */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 2rem;
      background-color: #f4f7f9;
      color: #333;
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 2rem;
    }
    h2 {
      margin: 0;
      color: #34495e;
      font-size: 1.5rem;
    }
    h3 {
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 0.5rem;
      margin-top: 1.5rem;
      margin-bottom: 1rem;
      color: #34495e;
      font-weight: 600;
    }

    /* File Upload Styling */
    #upload {
      display: block;
      margin: 0 auto 2rem auto;
    }

    /* Modality Container (Card) */
    .modality-container {
      background: #ffffff;
      border: 1px solid #e1e8ed;
      border-radius: 8px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      overflow: hidden; /* Ensures child borders don't poke out */
    }

    /* Header within the card (Holds Title and Buttons) */
    .modality-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      background-color: #f8f9fa;
      border-bottom: 1px solid #e1e8ed;
    }

    /* Archetype Button Styling */
    .archetype-buttons {
      display: flex;
      gap: 0.5rem;
    }
    .archetype-button {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      font-weight: 600;
      border: 1px solid #bdc3c7;
      border-radius: 5px;
      background-color: #ffffff;
      color: #2c3e50;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
    }
    .archetype-button:hover {
      background-color: #ecf0f1;
      border-color: #3498db;
    }
    .archetype-button.active {
      background-color: #3498db;
      color: #ffffff;
      border-color: #3498db;
    }

    /* Content Area for the active archetype */
    .archetype-content-panel {
      padding: 1.5rem;
      display: none; /* Hidden by default */
    }
    .archetype-content-panel.active {
      display: block; /* Shown when active */
    }

    /* Grid layout for Static Fields */
    .static-fields-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1rem;
      align-items: center;
    }
    .static-field {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }
    .static-field label {
      color: #555;
      margin-right: 1rem;
      white-space: nowrap;
    }

    /* Table Styling */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #e0e0e0;
      padding: 0.6rem 0.5rem;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
      font-weight: 600;
    }
    tbody tr:nth-child(odd) {
      background-color: #fdfdfd;
    }
    td:first-child {
      text-align: left;
      font-weight: 500;
      background-color: #f8f8f8;
      width: 250px; /* Give the label column a fixed width */
    }

    /* Input Field Styling */
    input[type="text"] {
      width: 6rem;
      padding: 0.4rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      transition: border-color 0.2s;
      text-align: center;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #3498db;
    }
  </style>
</head>
<body>
  <h1>Scenario Configurator</h1>
  <input type="file" id="upload" accept=".csv"><br><br>
  <div id="app"></div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // --- DATA DEFINITIONS ---

    const staticFields = [
      "non_demographic_growth", "routine_machine_hours", "share_of_scans_during_day",
      "ooh_machines", "ras_per_routine_machine_hour", "mit_shift_length",
      "mit_weeks_lost", "session_length_hours", "clinical_reporting_sessions_per_rad", "rad_weeks_lost"
    ];

    const staticFieldLabels = {
      "non_demographic_growth": "Non-Demographic Growth",
      "routine_machine_hours": "Routine Machine Hours",
      "share_of_scans_during_day": "Share of Scans During Day",
      "ooh_machines": "Out-of-Hours (OOH) Machines",
      "ras_per_routine_machine_hour": "RAs per Routine Machine Hour",
      "mit_shift_length": "MIT Shift Length",
      "mit_weeks_lost": "MIT Weeks Lost",
      "session_length_hours": "Session Length (Hours)",
      "clinical_reporting_sessions_per_rad": "Clinical Reporting Sessions per Rad",
      "rad_weeks_lost": "Radiologist Weeks Lost"
    };

    const projectionMetrics = [
      "ip_volume_step", "op_volume_step", "scan_rate", "report_rate",
      "mits_per_routine_machine_hour", "mits_per_ooh_machine_hour"
    ];

    const projectionMetricLabels = {
      "ip_volume_step": "Inpatient Volume Step",
      "op_volume_step": "Outpatient Volume Step",
      "scan_rate": "Scan Rate",
      "report_rate": "Report Rate",
      "mits_per_routine_machine_hour": "MITs per Routine Machine Hour",
      "mits_per_ooh_machine_hour": "MITs per OOH Machine Hour"
    };

    const years = Array.from({length: 11}, (_, i) => `y${i}`);
    const app = document.getElementById("app");

    // --- EVENT LISTENERS ---

    document.getElementById("upload").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: ({ data }) => renderUI(data)
      });
    });

    app.addEventListener('click', (e) => {
      if (!e.target.matches('.archetype-button')) return;

      const button = e.target;
      const targetPanelId = button.dataset.target;
      const contentPanel = document.querySelector(targetPanelId);

      const parentContainer = button.closest('.modality-container');
      parentContainer.querySelectorAll('.archetype-button').forEach(btn => btn.classList.remove('active'));
      parentContainer.querySelectorAll('.archetype-content-panel').forEach(panel => panel.classList.remove('active'));

      button.classList.add('active');
      contentPanel.classList.add('active');
    });

    // --- UI RENDERING LOGIC ---

    function renderUI(data) {
      app.innerHTML = "";
      const grouped = {};

      for (const row of data) {
        const modality = row["modality"];
        const archetype = row["archetype"];
        if (!grouped[modality]) grouped[modality] = {};
        grouped[modality][archetype] = row;
      }

      for (const modality of Object.keys(grouped)) {
        const modalityContainer = document.createElement("div");
        modalityContainer.className = "modality-container";
        modalityContainer.dataset.modality = modality;

        const header = document.createElement("div");
        header.className = "modality-header";
        
        const title = document.createElement("h2");
        title.textContent = modality;
        
        const buttonGroup = document.createElement("div");
        buttonGroup.className = "archetype-buttons";

        const contentArea = document.createElement("div");
        contentArea.className = "modality-content";

        header.appendChild(title);
        header.appendChild(buttonGroup);
        modalityContainer.appendChild(header);
        modalityContainer.appendChild(contentArea);

        // REMOVED: `let isFirstArchetype = true;`

        for (const archetype of Object.keys(grouped[modality])) {
          const row = grouped[modality][archetype];
          const contentPanelId = `content-${modality.replace(/\s+/g, '-')}-${archetype.replace(/\s+/g, '-')}`;

          const button = document.createElement("button");
          button.className = "archetype-button";
          button.textContent = archetype;
          button.dataset.target = `#${contentPanelId}`;
          buttonGroup.appendChild(button);

          const panel = document.createElement("div");
          panel.className = "archetype-content-panel";
          panel.id = contentPanelId;

          // REMOVED: The `if (isFirstArchetype)` block that auto-opened the first panel.
          
          const staticHeader = document.createElement("h3");
          staticHeader.textContent = "Static Fields";
          panel.appendChild(staticHeader);

          const staticGrid = document.createElement("div");
          staticGrid.className = "static-fields-grid";
          staticFields.forEach(field => {
            const fieldDiv = document.createElement("div");
            fieldDiv.className = "static-field";
            const label = document.createElement("label");
            label.textContent = staticFieldLabels[field] || field;
            const input = document.createElement("input");
            input.type = "text";
            input.value = row[field] || "";
            input.dataset.field = field;
            input.dataset.id = row["id"];
            fieldDiv.appendChild(label);
            fieldDiv.appendChild(input);
            staticGrid.appendChild(fieldDiv);
          });
          panel.appendChild(staticGrid);

          const tableHeader = document.createElement("h3");
          tableHeader.textContent = "Yearly Projections";
          panel.appendChild(tableHeader);

          const table = document.createElement("table");
          const thead = table.createTHead();
          const tbody = table.createTBody();

          const headerRow = thead.insertRow();
          headerRow.innerHTML = "<th>Metric</th>" + years.map(y => `<th>${y.toUpperCase()}</th>`).join("");
          
          projectionMetrics.forEach(metric => {
            const tr = tbody.insertRow();
            const labelCell = tr.insertCell();
            labelCell.textContent = projectionMetricLabels[metric] || metric;

            years.forEach(y => {
              const key = `${metric}_${y}`;
              const cell = tr.insertCell();
              const input = document.createElement("input");
              input.type = "text";
              input.dataset.field = key;
              input.value = row[key] || "";
              cell.appendChild(input);
            });
          });

          panel.appendChild(table);
          contentArea.appendChild(panel);
        }

        app.appendChild(modalityContainer);
      }
    }
  </script>
</body>
</html>